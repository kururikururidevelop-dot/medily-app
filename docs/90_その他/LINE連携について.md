以下のとおり
「LINEへの通知」「LINEからの受信（Webh。ook）」「マッチング処理」はすべて Firebase Cloud Functions で開発予定です。
現状のソースが方針に沿っていない場合修正をお願いします。
また、LINE連携に必要な情報は環境変数に追加し、記載個所を教えてしてください。

■方針
「LINEへの通知」「LINEからの受信（Webh。ook）」「マッチング処理」は、すべて Firebase Cloud Functions で開発

1. LINEへの通知（送信側）
ユーザーが質問を投稿した際や、回答が届いた際の通知です。
理由: 通知処理には時間がかかる場合があり、Web画面（フロントエンド）で直接送ると、送信完了まで画面が固まってしまいます。
仕組み: フロントエンドはFirestoreにデータを書き込むだけで終了し、Functionsが**「Firestoreへの書き込み」を検知（Trigger）してバックグラウンドでLINEへ通知を送信**します。これにより、ユーザーはサクサク操作を続けられます。

2. LINEからの受信（Webhook側）
ユーザーがLINE公式アカウントにメッセージを送ったり、ボタンをクリックしたりした際の処理です。
理由: LINE Messaging APIは、メッセージを受け取るための「公開されたサーバーのURL（Webhook URL）」を必要とします。
仕組み: FunctionsをHTTPSエンドポイント（APIの受付窓口）として公開し、LINEからの信号を受け取ります。受け取った内容に応じて、Firestoreのステータスを更新したり、次のアクションを実行したりします。

3. マッチング処理（計算・ロジック側）
前述したスコアリング（3pt/2pt/1pt）や検索の実行です。
理由1（セキュリティ）: マッチングには「全ユーザーのプロフィール」を参照する必要があります。これをフロントエンド（Web画面）で行うと、全ユーザーのデータがブラウザに流れてしまい、セキュリティ事故に繋がります。
理由2（計算負荷）: スコア付けや検索は計算量が多いため、サーバーサイドで実行するのが効率的です。
理由3（タイマー起動）: 「3時間経っても回答がなければ再マッチング」という処理は、Web画面を閉じている間も動く必要があるため、**Scheduled Functions（タイマー起動）**が必須です。

■機能概要
# マッチングのステータス
- マッチング中：まだマッチング先が見つかっていない状態
- マッチング不可：マッチングできなかった状態
- 回答待ち；マッチングができて回答を待っている状態
- 回答あり：マッチングができて回答があった状態
- クローズ：質問者が回答受付を終了した状態
- 自動クローズ：システムが回答受付を終了した状態

# マッチングのパターン
- 新規質問：マッチングを行う 
- 追加質問：ステータスが「回答待ち」か「回答あり」の場合は「通知メンバー」に追加質問を通知する。左記でなければマッチングを行う。
- 個別質問：特定の回答者に質問を通知する。

# マッチング（随時起動 or タイマー起動）
1. 全メンバーからプロフィールの地域（都道府県）と質問の地域が一致するメンバーを検索する。（このメンバーを「マッチグループ」と呼称する）
2. 1.が0件の場合、全メンバーからプロフィールの地域（都道府県）の隣接地域（都道府県）と質問の地域の隣接地域（都道府県）が一致するメンバーを検索する。（このメンバーを「マッチグループ」と呼称する）
3. 「マッチグループ」のメンバーのプロフィールのカテゴリまたは過去回答のカテゴリと質問のカテゴリが一致するか判定する。
4. 「マッチグループ」のメンバーの年齢（生まれ年から算出）が質問の年代の範囲に入っているか判定する。
5. ランク付けを行う。
5. 「マッチグループ」から同じ質問の「通知メンバー」になったことがないメンバーを配点の高い順に最大10名抽出する。（このメンバーを「通知メンバー」と呼称する）
6. 「通知メンバー」が0件の場合、ステータスが「クローズ」以外であれば、質問者に”現在、回答者を探しています”旨を通知する。ステータスを「マッチング不可」にする。
7. 「通知メンバー」に対して通知する。「通知メンバー」を記録しておく。ステータスを「回答待ち」にする。

# ランク付け
| 評価項目 | 配点 | 内容・狙い |
| --- | --- | --- |
| **カテゴリ一致** | **3pt** | **【最優先】** 相談内容と同じ診療科や症状の経験がある。 |
| **地域一致** | **2pt** | 同じ都道府県の病院事情に詳しい（近隣県は1pt）。 |
| **年代一致** | **1pt** | 質問者の年代（30代など）に近いライフステージの経験。 |


# タイマー処理（自動クローズ、再マッチング）
1. ステータスが「回答あり」かつ一定時間経過（48時間）かつ 新たなやり取りがない場合、ステータスを「自動クローズ」に更新し、回答ずみの回答者への感謝通知と「貢献度」を更新する。
2. ステータスが「回答待ち」かつ一定時間経過（3時間）している場合、再度マッチングを行う。