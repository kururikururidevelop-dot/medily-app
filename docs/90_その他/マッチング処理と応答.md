# マッチング処理概要
## 用語定義
- マッチング：回答者を検索して、質問者に通知する
- 通知：回答者を検索して、質問者に通知する
- マッチンググループ：マッチングしたユーザーのグループ
- 通知ユーザー：マッチンググループのうち通知済みのユーザー

## マッチングのステータス
- マッチング中：まだマッチング先が見つかっていない状態
- マッチング不可：マッチングできなかった状態
- 回答待ち；マッチングができて回答を待っている状態
- 回答あり：マッチングができて回答があった状態

## マッチングのパターン
- 新規質問：通常のマッチングを行う。
- 追加質問：ステータスが「回答待ち」または「回答あり」の場合は「通知ユーザー」とマッチングさせる。左記でなければ通常のマッチングを行う。
- 個別質問：特定の回答者とマッチングさせる。

## 通常マッチング
1. 質問の地域が全ユーザーのプロフィールの地域（都道府県）と一致するか検索をする。
2. 質問の地域が全ユーザーのプロフィールの地域（都道府県）の隣接地域（都道府県）と一致するか検索をする。（地域と隣接地域に該当したユーザーが「マッチンググループ」になる）
3. 質問のカテゴリが「マッチンググループ」のユーザーのプロフィールのカテゴリまたは過去回答のカテゴリと一致するか判定する。
4. 質問の年代が「マッチンググループ」のユーザーのプロフィールの生まれ年から算出した年齢の範囲に入っているか判定する。
5. ランク付けを行う。（重複した項目はポイントにしないこと）
6. 「マッチンググループ」の中で質問の「通知ユーザー」外のユーザーをランクの配点が高い順に最大10名抽出する。（この抽出されたユーザーが通知対象になる）
7. 通知対象がいない場合、質問に対する回答が1件もなければ、質問者に”現在、回答者を探しています”旨を通知後、ステータスを「マッチング不可」にする。回答が1件以上ある場合は、ステータスを「回答あり」にする。
8. 「通知ユーザー」に対して通知後、「通知ユーザー」を記録しておき、ステータスを「回答待ち」にする。

## ランク付け
| 評価項目 | 配点 | 内容・狙い |
| --- | --- | --- |
| **カテゴリ一致** | **3pt** | **【最優先】** 相談内容と同じ診療科や症状の経験がある。 |
| **地域一致** | **2pt** | 同じ都道府県の病院事情に詳しい（近隣県は1pt）。 |
| **年代一致** | **1pt** | 質問者の年代（30代など）に近いライフステージの経験。 |

## タイマー処理（自動クローズ、再マッチング）
1. ステータスが「回答待ち」かつ一定時間経過（3時間）している場合、ステータスを「マッチング中」に変更し再度マッチングを行う。
2. ステータスが「マッチング不可」かつ一定時間経過（24時間）している場合、ステータスを「マッチング中」に変更し再度マッチングを行う。

# 応答の流れ
## 質問通知～回答入力（登録ユーザーの場合）
1. 回答者に質問が通知される
2. 回答者が質問に記載されているURLをクリックする
3. 回答入力画面に遷移する
4. 回答入力画面で回答入力する（ステータスを「回答あり」にする）
5. 回答者に感謝が通知される（システムが自動応答する）

## 質問通知～回答入力（ゲストユーザーの場合）
1. 回答者は質問一覧（公開）で質問を閲覧後、選択する
2. 回答入力画面に遷移する
3. 回答入力画面で回答入力する（回答入力時にユーザー登録する／しないの選択をさせる）
4. ユーザー登録した場合は、回答者に感謝が通知される（システムが自動応答する）

## 回答通知～回答確認
1. 質問者に回答が通知される
2. 質問者が回答に記載されているURLをクリックする。
3. 質問詳細画面に遷移する。
4. 質問詳細画面で回答を確認する
5. 質問者がまだ質問を受け付ける場合、回答あり→マッチング中へステータスを変更する。

# マッチング処理、応答の実装
マッチングやLINE通知はトリガー処理やAPI外部連携をおこなうためfirebase functionsでを実装する。
