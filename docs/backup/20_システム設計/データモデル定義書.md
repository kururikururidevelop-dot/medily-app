# データモデル設計書

**医療クローズド相談マッチングサービス**
バージョン：1.0
作成日：2025-12-07

---

## 目的

本ドキュメントは、サービス全体で使用する**データモデル（Firestore 想定）**を体系的に整理し、
各コレクション／フィールド／型／役割／制約／インデックス要件をまとめたものである。
バックエンド実装者・フロントエンジニア・データ分析担当者が参照し、
整合性のあるデータ構造を保つことを目的とする。

---

# 目次

1. 全体構造
2. コレクション一覧
3. データモデル詳細

   * users
   * questions
   * questions/{questionId}/batches
   * threads
   * threads/{threadId}/messages
   * matches
   * notifications
   * reports
4. ERライク関連図
5. Firestore セキュリティルール方針
6. インデックス要件（推奨）
7. 将来拡張に備えたフィールド方針

---

# 1. 全体構造（ハイレベル）

```
users/{userId}
questions/{questionId}
  └ batches/{batchId}
threads/{threadId}
  └ messages/{messageId}
matches/{matchId}
notifications/{notifId}
reports/{reportId}
```

Firestore はドキュメント型のため、
重要なのは「参照関係」「読み取り頻度」「更新頻度」を考慮した構造である。

---

# 2. コレクション一覧

| コレクション                  | 内容                 | 主な用途            |
| ----------------------- | ------------------ | --------------- |
| `users`                 | 質問者・回答者の基本プロフィール   | マッチング、通知、表示     |
| `questions`             | 質問の本体              | マッチング処理の入口      |
| `questions/{q}/batches` | 回答者通知バッチ           | 大量通知の制御         |
| `threads`               | 質問者 ⇄ 回答者 の1対1チャット | 回答～追加質問～逆質問～再質問 |
| `threads/{t}/messages`  | チャットメッセージ          | 全履歴管理           |
| `matches`               | マッチング履歴            | 分析用、スコア改善       |
| `notifications`         | 通知ログ（LINE/X など）    | トラブル調査、再試行      |
| `reports`               | 通報                 | モデレーション         |

---

# 3. データモデル詳細

---

## 3.1 `users/{userId}`

### 用途

* 質問者・回答者の基本情報
* マッチングスコアの算出
* 通知先として利用

### スキーマ

| フィールド              | 型             | 説明                               |
| ------------------ | ------------- | -------------------------------- |
| `user_id`          | string        | UID（Authと一致）                     |
| `nickname`         | string        | 匿名名                              |
| `gender`           | string        | `male` / `female` / `other`      |
| `birthdate`        | timestamp     | 年代推定用                            |
| `age_range`        | string        | `"20s"`, `"30s"` など（計算済を保持してもよい） |
| `region`           | string        | 都道府県 or 大エリア                     |
| `profile_tags`     | array<string> | 専門科目・経験領域など                      |
| `linked.line_id`   | string        | LINE UID (匿名化)                   |
| `linked.x_id`      | string        | X(Twitter) UID                   |
| `last_active_at`   | timestamp     | アクティブ度スコアに利用                     |
| `past_answers`     | number        | 回答数                              |
| `past_answer_rate` | number        | 過去回答率（0〜1）                       |
| `is_suspended`     | bool          | 利用停止                             |

### インデックス推奨

* `region`
* `profile_tags`（配列検索）
* `last_active_at` 降順

---

## 3.2 `questions/{questionId}`

### 用途

* ユーザーが投稿する質問
* マッチング対象の質問

### スキーマ

| フィールド           | 型             | 説明                                                |
| --------------- | ------------- | ------------------------------------------------- |
| `question_id`   | string        | 自動ID                                              |
| `user_id`       | string        | 投稿者ID                                             |
| `title`         | string        | 質問タイトル                                            |
| `content`       | string        | 質問本文                                              |
| `choices`       | array<string> | 選択式質問（あれば）                                        |
| `category`      | string        | 医療カテゴリ                                            |
| `region`        | string        | 地域                                                |
| `gender_filter` | string/null   | 回答者性別の条件                                          |
| `age_filter`    | object        | `{min: number, max: number}`                      |
| `status`        | string        | `waiting_for_answer` / `active_thread` / `closed` |
| `created_at`    | timestamp     | 作成日時                                              |
| `updated_at`    | timestamp     | 更新日時                                              |

### インデックス推奨

* `region, category, created_at` の複合
* `user_id, created_at` の複合

---

## 3.3 `questions/{q}/batches/{batchId}`

### 用途

* 回答者への通知を段階的に送るためのバッチ
* マッチング負荷をさばくための重要構造

### スキーマ

| フィールド            | 型             | 説明                                          |
| ---------------- | ------------- | ------------------------------------------- |
| `batch_id`       | string        | 自動ID                                        |
| `order`          | number        | バッチ番号（1,2,3…）                               |
| `user_ids`       | array<string> | このバッチで通知する回答者                               |
| `status`         | string        | `waiting` / `sent` / `expired` / `canceled` |
| `notified_at`    | timestamp     | 通知時刻                                        |
| `expires_at`     | timestamp     | タイムアウト時刻                                    |
| `score_snapshot` | array<object> | `{user_id, score}` の簡易ログ                    |

### インデックス推奨

* `order` 昇順
* `status`

---

## 3.4 `threads/{threadId}`

### 用途

* 質問者⇄回答者の1対1チャット管理
* 質問と回答が成立した時点で作成

### スキーマ

| フィールド           | 型         | 説明                                             |
| --------------- | --------- | ---------------------------------------------- |
| `thread_id`     | string    | 自動ID                                           |
| `question_id`   | string    | 紐づく質問                                          |
| `questioner_id` | string    | 質問者ID                                          |
| `answerer_id`   | string    | 回答者ID                                          |
| `status`        | string    | `active` / `closed`                            |
| `created_at`    | timestamp |                                                |
| `updated_at`    | timestamp |                                                |
| `read_at`       | object    | `{questioner: timestamp, answerer: timestamp}` |

### インデックス推奨

* `questioner_id`
* `answerer_id`

---

## 3.5 `threads/{threadId}/messages/{messageId}`

### 用途

* チャットメッセージ（全種類）
* 初回回答・追加質問・逆質問・再質問を区別する type を保持

### スキーマ

| フィールド        | 型         | 説明                                                                                                 |
| ------------ | --------- | -------------------------------------------------------------------------------------------------- |
| `message_id` | string    | 自動ID                                                                                               |
| `from`       | string    | `questioner` / `answerer` / `system`                                                               |
| `type`       | string    | `initial_question` / `answer` / `followup_question` / `reverse_question` / `requestion` / `system` |
| `text`       | string    | 本文                                                                                                 |
| `meta`       | object    | 追加情報（URL、位置、choice index）                                                                          |
| `created_at` | timestamp | 送信時刻                                                                                               |

### インデックス

* `created_at`（チャット時系列表示用）

---

## 3.6 `matches/{matchId}`

### 用途

* マッチング履歴
* 分析（回答率向上、スコアリング最適化）

### スキーマ

| フィールド         | 型         | 説明                     |
| ------------- | --------- | ---------------------- |
| `question_id` | string    |                        |
| `answerer_id` | string    |                        |
| `match_score` | number    | 計算時スコア                 |
| `status`      | string    | `selected` / `ignored` |
| `created_at`  | timestamp |                        |

---

## 3.7 `notifications/{notifId}`

### 用途

* 通知ログ（LINE/X/In-app）
* 再試行処理や障害調査に必須

### スキーマ

| フィールド | 型 | 説明 |
| `to_user_id` | string | 受信者 |
| `channel` | string | `line` / `x` / `inapp` |
| `payload` | object | 通知内容（リンク等） |
| `status` | string | `pending` / `sent` / `failed` |
| `sent_at` | timestamp | 送信時刻 |

---

## 3.8 `reports/{reportId}`

### 用途

* 不適切ユーザーの通報

### スキーマ

| フィールド         | 型         | 説明                              |
| ------------- | --------- | ------------------------------- |
| `target_type` | string    | `user` / `message`              |
| `target_id`   | string    | 該当ID                            |
| `reporter_id` | string    | 通報者                             |
| `reason`      | string    | 箇条書きにしてもよい                      |
| `status`      | string    | `open` / `reviewing` / `closed` |
| `created_at`  | timestamp |                                 |

---

# 4. ERライク関連図（抽象）

```
users (1) --- (N) questions
users (1) --- (N) threads (as answerer)
questions (1) --- (N) batches
questions (1) --- (1) threads
threads (1) --- (N) messages
threads (N) --- (1) users (both sides)
```

※ Firestore は RDB ではないためリレーションは論理的な関係を示す。

---

# 5. Firestore セキュリティルール方針（概要）

### users

* 読み取り：本人のみ詳細、他人は公開情報のみ
* 書き込み：本人のみ

### questions

* 読み取り：公開 or 質問者本人
* 書き込み：質問者本人

### batches

* 読み書き：サーバのみ（client deny）

### threads / messages

* 読み書き：participants のみ

### notifications

* 書き込み：サーバのみ

### reports

* 読み取り：管理者のみ
* 書き込み：ログインユーザー

---

# 6. インデックス要件（推奨）

### 単一インデックス

* users.region
* users.last_active_at
* questions.category
* messages.created_at

### 複合インデックス

| コレクション      | フィールド                                     |
| ----------- | ----------------------------------------- |
| `questions` | region ASC, category ASC, created_at DESC |
| `questions` | user_id ASC, created_at DESC              |
| `batches`   | question_id ASC, order ASC                |
| `batches`   | status ASC, order ASC                     |

---

# 7. 将来拡張に備えたフィールド方針

* 質問に**画像添付**する場合 → `questions/{q}/attachments` サブコレクション
* 回答者評価（star rating） → `threads.rating`
* 質問の公開範囲（限定公開、URL公開） → `visibility` フィールド
* ブロック機能 → `users/{u}/blocks/{blockedUserId}`
* 通知ミュート → `users.notification_settings`

---

# ✔ 次に作成可能なもの

必要であれば以下も作成できます：

* **Firestore Security Rules全文**
* **OpenAPI（YAML）でのAPI仕様書**
* **Cloud Functionsの実装サンプル**
* **DBマイグレーション方針**
* **業務フロー図 / シーケンス図**

次にどれを作成しますか？
