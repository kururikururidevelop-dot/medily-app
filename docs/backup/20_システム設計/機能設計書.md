# 医療クローズド相談マッチングサービス機能設計書

# サービス概要
医療に関する不安・病院選びの悩みを抱えるユーザー（質問者）と、その領域の患者経験を持つユーザー（回答者）を**1対1のクローズド環境**でマッチングし、体験ベースの情報提供を行うサービス。
口コミや公開レビューに頼れない医療領域で「匿名・安全」に相談でき、経験者が短時間で人助けできる仕組みを提供する。
（参考：企画書の「サービス概要」「背景」「コンセプト」）

# 想定ユーザーとニーズ
## 質問者ペルソナ（抜粋）
各医療科目ごとに、以下のニーズが存在する：
（参考：質問者ペルソナ資料 ）

* **内科**：治療方針比較・長期通院の不安解消
* **整形外科**：リハビリの実態・通院相性
* **皮膚科**：治療比較・副作用経験
* **精神科**：病院の雰囲気・初診ハードル
* **婦人科**：非公開で相談したいデリケートな内容
* **小児科**：安心できる病院選び
* **歯科**：矯正・インプラントの生体験
* **眼科**：手術体験談
* **がん診療**：体験ベースの高度医療情報（診断はNG）

共通ニーズ：
* 病院や医師の「実際の対応」を知りたい
* 通院前の不安を減らしたい
* 患者経験のリアルな声が必要

# サービス全体構成
```
質問者・回答者は共にPRサイトから登録
```
（参考：企画書「サービスの流れ（UX）」）

# 機能分類と要件
## 認証・ログイン機能
### 目的
利用者が安全にサービスを利用開始できるようにし、利用状況に応じた画面制御を可能にする。

### 対象画面
* PRサイトTOP
* OAuth選択
* 初回プロフィール登録

### 機能一覧
| No  | 機能名             |
| --- | ------------------ |
| 1   | 外部アカウント認証 |
| 2   | ログイン状態管理   |
| 3   | 初回利用者判定     |
| 4   | 権限状態の制御     |
| 5   | ログアウト処理     |

### 機能概要
#### 外部アカウント認証
利用者はGoogle、LINE、Xなどの外部サービスのアカウントを利用して認証を行う。
認証が成功した場合、サービス利用に必要な最低限の識別情報が取得される。

#### ログイン状態管理
認証後はログイン状態が維持され、連続してサービスを利用できる。
一定時間操作がない場合は自動的にログイン状態が解除される。

#### 初回利用者判定
初めてログインした利用者は、通常の利用画面に遷移せず、プロフィール登録画面へ誘導される。
必要情報が登録されるまで、質問投稿や回答機能は利用できない。

#### 権限状態の制御
利用者の状態（認証済み／未認証／登録未完了）に応じて、
利用できる画面や操作が制御される。

#### ログアウト処理
利用者は任意のタイミングでログアウトでき、ログアウト後は認証を必要とする機能が利用不可になる。

### 非機能要件
* 認証結果の成否が利用者にわかりやすく表示されること
* 複数端末からの同時ログインでも状態が破綻しないこと
* ユーザー操作に対して不自然な待機時間が発生しないこと

### 特記事項
* 認証に失敗した場合でも、再試行手段が明示されること
* 長期間ログインしていない利用者に対しては再認証を促すこと

## プロフィール管理機能
### 目的
マッチング精度とサービス体験を向上させるため、利用者情報を適切に登録・管理できるようにする。

### 対象画面
* 初回プロフィール登録
* プロフィール編集
* マイページ

### 機能一覧
| No  | 機能名                 |
| --- | ---------------------- |
| 1   | 基本プロフィール登録   |
| 2   | プロフィール表示       |
| 3   | プロフィール編集       |
| 4   | 入力内容バリデーション |
| 5   | 公開範囲制御           |

### 機能概要
#### 基本プロフィール登録
利用者はサービス利用に必要な最低限の情報（ニックネーム、地域、生まれた年、性別など）を登録できる。
登録される情報は、質問配信の対象選定や画面表示内容のカスタマイズに利用される。

#### プロフィール表示
利用者自身のプロフィール情報を画面上に一覧形式で確認できる。
実名や連絡先などの個人特定につながる情報は表示対象としない。

#### プロフィール編集
登録済みのプロフィール情報は、後から変更できる。
変更内容は保存完了後すぐに反映され、以降の利用条件に適用される。

#### 入力内容バリデーション
入力内容に不備がある場合は、保存前に利用者へ分かりやすく通知する。
未入力項目や形式不一致は明示的に表示される。

#### 公開範囲制御
プロフィール内の一部情報は、
「他ユーザーに共有される情報」と「システム内部のみ保持される情報」に分けて管理される。

### 非機能要件
* 登録・編集操作中のデータが意図せず消失しないこと
* 表示内容と保存内容に不整合が生じないこと
* 編集後の内容が即時に画面へ反映されること

### 特記事項
* プロフィール未登録の状態では質問投稿や回答は不可とする
* 年齢や性別などのセンシティブ情報については詳細な数値ではなく区分表示とする
* 個人が特定されないように実名や生年月日ではなくニックネームと生まれた年を登録する

## 質問管理機能
### 目的
利用者が悩みや疑問を投稿し、適切に管理できるようにすることで、安心して相談できる環境を提供する。
また、回答者からの逆質問に対して質問者が再質問（追加質問）できる仕組みを提供する。

### 対象画面
* ホーム
* 質問投稿
* 質問投稿確認
* 質問投稿完了
* 質問詳細（質問者）
* 質問詳細（公開）
* 質問一覧（自分）
* チャット

### 機能一覧

| No  | 機能名                         |
| --- | ------------------------------ |
| 1   | 質問作成                       |
| 2   | 質問内容確認                   |
| 3   | 質問公開制御                   |
| 4   | 質問一覧表示                   |
| 5   | 質問詳細表示                   |
| 6   | 質問ステータス管理             |
| 7   | 質問終了処理                   |
| 8   | 逆質問受信                     |
| 9   | 逆質問者への再質問（追加質問） |
| 10  | 再質問の管理                   |

### 機能概要
#### 質問作成
利用者は自由記述で質問内容を入力し、選択肢やテンプレートを利用して投稿内容を構成できる。
質問には地域、性別条件、年齢条件などの絞り込み条件を設定できる。

#### 質問内容確認
投稿前に入力した内容を確認できる確認画面を提供する。
誤入力を防ぐため、内容の見直しができる機会を必ず設ける。

#### 質問公開制御
質問は「公開」または「非公開」を選択できる。
公開質問はマッチング対象となり、非公開質問は本人のみが閲覧可能となる。

#### 質問一覧表示
利用者は自分が投稿した質問を一覧形式で確認できる。
進行中・回答待ち・終了済みなどの状態が一覧上で識別できる。

#### 質問詳細表示
質問の本文、選択肢、投稿条件、現在の状態などを詳細画面で確認できる。
質問者本人には管理用の操作ボタンが表示される。

#### 質問ステータス管理
質問ごとに状態を管理し、画面上で確認できるようにする。

| 状態名     | 概要                             |
| ---------- | -------------------------------- |
| 下書き     | 作成途中の質問                   |
| 質問中     | 回答受付中の質問                 |
| 回答あり   | 回答が発生した質問               |
| 逆質問あり | 回答者からの逆質問が発生した質問 |
| 再質問中   | 質問者が再質問中                 |
| 終了       | 受付を終了した質問               |

#### 質問終了処理
質問者は任意のタイミングで質問を終了できる。
終了後は新たな回答受付は行われない。

#### 逆質問受信
回答者が送信した追加情報確認のメッセージ（逆質問）を、質問者側で受信・表示できる。
逆質問は質問詳細画面またはチャット画面上で確認できる。

#### 逆質問者への再質問（追加質問）
質問者は、逆質問を送信した特定の回答者に対してのみ、追加情報を送信できる。
この再質問は通常の質問と区別され、対象の回答者のみに通知される。

#### 再質問の管理
逆質問とそれに対する再質問の履歴を管理し、時系列で確認できる。
質問の流れは以下のパターンで管理する。

| パターン         | 説明                                 |
| ---------------- | ------------------------------------ |
| 初回質問         | 質問者が最初に投稿した質問           |
| 追加質問         | 質問者が任意で追記した補足質問       |
| 逆質問への再質問 | 回答者の逆質問に対する回答／追加情報 |

### 非機能要件
* 同一操作の多重実行でも質問が重複登録されないこと
* 投稿後の内容は意図しない形で第三者に特定されないこと
* 画面表示と実データの状態が一致していること
* 逆質問と再質問の対応関係が明確に管理されること
* 誤操作によって意図しない相手に再質問が送信されないこと

### 特記事項
* 医療関連の内容については注意喚起表示を常に行う
* 不適切な表現を検知した場合は利用者に修正を促す
* 逆質問は定型文または自由記述のどちらにも対応する
* 再質問は逆質問単位で紐づけて管理する

## マッチング機能
### 目的
質問者の投稿内容に対して、適切な回答者を選定し、効率的に質問を届けることで回答率と品質を高める。

### 対象画面
* ホーム（質問配信の入口）
* 質問詳細（質問者）
* 質問詳細（回答者）
* チャット

### 機能一覧
| No  | 機能名                       |
| --- | ---------------------------- |
| 1   | 回答者候補の抽出             |
| 2   | 質問配信制御                 |
| 3   | 再マッチング制御             |
| 4   | マッチング状態管理           |
| 5   | マッチング解除               |
| 6   | 逆質問者との再マッチング制御 |

### 機能概要
#### 回答者候補の抽出
質問が投稿されると、質問内容のカテゴリ、地域、性別条件、年齢条件などをもとに、条件に合致する回答者候補を抽出する。
回答可能状態（離脱中・制限中は除外）のユーザーのみが対象となる。

#### 質問配信制御
抽出された候補の中から、**一度に配信する人数を制限**して質問を通知する。
配信人数はシステム側で制御可能とし、回答負荷の集中を防ぐ。

#### 再マッチング制御
一定時間内に回答が得られなかった場合、次の候補グループへ質問を再配信する。
この処理は自動で行われ、質問者の操作は不要とする。

#### マッチング状態管理
質問ごとに以下のような状態を管理する。

| 状態名   | 概要                              |
| -------- | --------------------------------- |
| 未マッチ | まだ候補抽出のみ行われた状態      |
| 配信中   | 回答候補者に配信されている状態    |
| 回答あり | 少なくとも1件の回答が行われた状態 |
| 終了     | 質問者によりクローズされた状態    |

#### マッチング解除
以下の条件でマッチングは解除される。
* 質問者が質問を終了した場合
* 既定の最大配信回数に達した場合
* 一定期間が経過した場合

解除後は新たな回答受付は行わない。

#### 逆質問者との再マッチング制御
回答者が逆質問を送信した場合、その回答者を**「固定マッチ対象」**として扱う。
この状態では以下の制御を行う。
* 通常の候補抽出とは別枠で対象回答者を保持する
* 質問者が「逆質問への再質問」を行った際、該当回答者のみに通知を送信する
* 他の候補者への一斉配信は行わない

### 非機能要件
* 大量の同時投稿時でもマッチング処理が滞らないこと
* 回答者側には通知が過剰に集中しないよう調整されること
* 状態遷移が画面に即時反映されること

### 特記事項
* 回答者の負荷状況（過去の回答回数、直近の稼働状況）を考慮して配信優先度を調整できるようにする
* マッチングロジックは将来的なチューニングを前提に拡張余地を持たせる

## 回答管理機能
### 目的
回答者が質問に対して適切な回答を行い、その履歴を安全に管理できる環境を提供する。
また、必要に応じて質問者へ逆質問を送信できる仕組みを提供する。

### 対象画面
* 質問詳細（回答者）
* 回答入力
* 回答完了
* 回答一覧（回答者）
* チャット

### 機能一覧（項番維持）

| No  | 機能名             |
| --- | ------------------ |
| 1   | 質問閲覧           |
| 2   | 回答入力           |
| 3   | 選択肢回答         |
| 4   | 回答送信           |
| 5   | 回答完了表示       |
| 6   | 回答履歴管理       |
| 7   | 回答ステータス管理 |
| 8   | 逆質問送信         |

### 機能概要
#### 質問閲覧
回答者はシステムから配信された質問内容を確認できる。
質問には必要に応じて条件情報（地域・年齢帯・性別など）が表示される。

#### 回答入力
回答者は質問形式に応じて、簡易な回答内容を入力できる。

#### 選択肢回答
質問に選択肢が設定されている場合、回答者はその中から回答を選択できる。

#### 回答送信
入力した内容を送信することで、質問者へ回答内容が反映される。

#### 回答完了表示
回答送信後は、完了状態を明確に伝える画面またはメッセージを表示する。

#### 回答履歴管理
自身が過去に行った回答を一覧形式で確認できる。
進行中の質問と終了済みの質問は区別して表示される。

#### 回答ステータス管理

| 状態名       | 概要                               |
| ------------ | ---------------------------------- |
| 未回答       | まだ回答していない状態             |
| 回答済       | 回答を送信済みの状態               |
| 逆質問送信済 | 逆質問を送信済みの状態             |
| クローズ     | 質問が終了し、回答不可となった状態 |

#### 逆質問送信
回答者は、回答内容に加えて質問者へ逆質問を送信できる。
逆質問は定型文または自由記述で入力できる。
送信された逆質問は、質問者側の画面および通知に反映される。

### 非機能要件（追記済み）
* 回答送信後のデータが即時に反映されること
* 二重送信・誤送信が発生しないこと
* 他ユーザーの情報が不正に閲覧できないこと
* 逆質問が誤った質問スレッドに紐づかないこと

### 特記事項（追記済み）
* 回答はLINEまたはXを通じて行う
* 回答内容は送信後に編集不可とする
* 医療的助言については注意文言を表示する
* 逆質問送信時は個人情報入力を抑止するガイダンスを表示する

## 外部サービス連携機能（LINE／X 統合）
### 目的
LINE または X の外部サービスを利用して、質問・回答に関する通知およびメッセージの受け渡しを行い、
システム外チャネルを通じた安全かつ効率的なコミュニケーションを実現する。

### 対象画面
* 質問詳細（質問者）
* 質問詳細（回答者）
* 通知設定
* 設定

### 機能一覧

| No  | 機能名                 |
| --- | ---------------------- |
| 1   | 外部アカウント連携管理 |
| 2   | 質問通知配信           |
| 3   | 回答通知配信           |
| 4   | 逆質問通知配信         |
| 5   | 再質問通知配信         |
| 6   | メッセージ中継制御     |
| 7   | 配信ログ管理           |
|     |                        |

### 機能概要
#### 外部アカウント連携管理
利用者はLINEまたはXのアカウントを本システムと連携させることができる。
連携情報はユーザー単位で管理される。

#### 質問通知配信
マッチング対象となった回答者に対して、質問内容の通知を外部サービス経由で配信する。

#### 回答通知配信
回答が登録された際に、質問者の外部アカウントに通知を配信する。

#### 逆質問通知配信
回答者が逆質問を送信した際に、質問者の外部アカウントに通知を配信する。

#### 再質問通知配信
質問者が逆質問に対して追加質問（再質問）を送信した際に、対象となる回答者に通知を配信する。

#### メッセージ中継制御
質問者と回答者間のメッセージは、必ずシステムを経由して外部サービスに送信される。
外部サービス上での直接的なユーザー同士の接続は行わない。

#### 配信ログ管理
外部サービスへの送信履歴・配信結果をログとして保存し、障害時の追跡を可能とする。

### 非機能要件
* 外部API障害時にシステムが停止しないこと
* 配信順序が保証されること
* 他ユーザー宛の通知が誤配信されないこと
* 冗長送信による通知スパムが発生しないこと

### 特記事項
* 通知本文には個人情報を含めない設計とする
* LINE／Xいずれか片方のみの利用も可能とする
* 利用API仕様変更に備えた抽象化レイヤーを設ける

## 一覧・検索機能
### 目的
利用者が大量の情報の中から必要な質問や回答を効率的に見つけられるようにする。

### 対象画面
* ホーム
* 質問一覧（自分）
* 回答一覧（回答者）

### 機能一覧
| No  | 機能名         |
| --- | -------------- |
| 1   | 一覧表示       |
| 2   | 状態別フィルタ |
| 3   | 並び替え       |
| 4   | 検索条件指定   |
| 5   | 検索結果表示   |

### 機能概要
#### 一覧表示
質問や回答をカード形式またはリスト形式で一覧表示する。
各項目には状態（募集中、回答済、終了済など）が視覚的に表示される。

#### 状態別フィルタ
進行中・未回答・終了済みなどの状態ごとに表示内容を絞り込める。

#### 並び替え
新着順、更新順などで表示順を変更できる。

#### 検索条件指定
キーワード、カテゴリ、地域などの条件を指定して検索できる。

#### 検索結果表示
条件に一致した質問・回答のみを一覧に表示する。

### 非機能要件
* 件数が多い場合でも表示が著しく遅延しないこと
* 検索結果が安定して表示されること
* 同一条件で同じ結果が取得できること

### 特記事項
* 公開範囲外の情報は検索対象外とする
* 利用者の権限状態に応じて表示対象を制御する

## マイページ機能
### 目的
利用者自身の活動状況を可視化し、サービスの利用状況を直感的に把握できるようにする。

### 対象画面
* マイページ
* ホーム

### 機能一覧

| No  | 機能名             |
| --- | ------------------ |
| 1   | アクティビティ表示 |
| 2   | ステータス可視化   |
| 3   | 履歴導線提供       |
| 4   | 設定導線提供       |
|     |                    |

### 機能概要
#### アクティビティ表示
自分が投稿した質問数、回答数などを集計して表示する。

#### ステータス可視化
質問の進行状況をアイコンやラベルで分かりやすく表現する。

#### 履歴導線提供
過去の質問一覧、回答一覧、チャット履歴への遷移リンクを提供する。

#### 設定導線提供
プロフィール編集、通知設定、利用規約などへの導線をまとめて表示する。

### 非機能要件
* 画面表示が一定時間以内に完了すること
* 情報が最新状態で表示されること
* 他ユーザーの情報が混在しないこと

### 特記事項
* 表示内容はログインユーザーごとに完全に分離される
* 未ログイン状態ではアクセス不可とする

## 設定・規約機能

### 目的
利用者がサービス利用に必要な各種設定を行い、ルールや方針を適切に理解できるようにする。

### 対象画面
* 設定
* 利用規約
* プライバシー
* 退会画面

### 機能一覧

| No  | 機能名       |
| --- | ------------ |
| 1   | 各種設定表示 |
| 2   | 設定内容変更 |
| 3   | 規約閲覧     |
| 4   | 同意管理     |
| 5   | 退会手続き   |

### 機能概要
#### 各種設定表示
利用者はアカウント関連設定や通知設定、表示設定などを一覧で確認できる。

#### 設定内容変更
各種設定項目のオン／オフや選択内容を変更できる。
変更後の内容は即時に反映される。

#### 規約閲覧
利用規約およびプライバシーポリシーの内容を専用画面で閲覧できる。

#### 同意管理
サービス利用に必要な規約への同意状態を管理し、未同意の場合は利用制限を行う。

#### 退会手続き
利用者は任意のタイミングで退会できる。
退会後はアカウント情報および投稿データの取り扱い方針に従って処理される。

### 非機能要件
* 設定変更による誤動作が発生しないこと
* 規約表示が途中で途切れないこと
* 退会処理が不完全な状態で止まらないこと

### 特記事項
* 退会後のデータ保持期間や範囲は別途運用規程に従う
* 法令改定時は規約内容の更新を行う