# 医療クローズド相談マッチングサービス機能設計書

# サービス概要
医療に関する不安・病院選びの悩みを抱えるユーザー（質問者）と、その領域の患者経験を持つユーザー（回答者）を**1対1のクローズド環境**でマッチングし、体験ベースの情報提供を行うサービス。
口コミや公開レビューに頼れない医療領域で「匿名・安全」に相談でき、経験者が短時間で人助けできる仕組みを提供する。
（参考：企画書の「サービス概要」「背景」「コンセプト」）

## サービスの主要フロー

### ■ フロー1：新規質問～回答～個別チャット～クローズ
1. **質問者**：LIFF で新規質問を投稿
2. **システム**：マッチング対象者（複数）に LINE でマルチキャスト通知
3. **回答者**（最初に反応した回答者）：LINE DM の Flex Message で回答を入力
   * 選択肢選択 + 場所情報 + URL + 短文（100-140文字）
   * 送信前に AI が診断行為・誹謗中傷などをチェック
4. **システム**：「質問ID - 回答者ID」の個別スレッドを確立
5. **質問者・回答者**：個別チャットスレッドで追加のやり取り（最大3往復まで）
6. **システム**：以下のいずれかでスレッドをクローズ
   * 質問者が「解決した」をクリック
   * 3往復に達する
   * 最終メッセージから 48 時間経過

### ■ フロー2：追加質問～回答～個別チャット～クローズ
1. **質問者**：LIFF で追加質問を投稿（新規質問と同一の質問スレッド内）
2. **システム**：新規質問でマッチングした全回答者に LINE でマルチキャスト通知
3. **回答者**（反応した回答者）：LINE DM で回答を入力（フロー1と同様）
4. 以降はフロー1と同じ個別チャット～クローズの流れ

---

# 想定ユーザーとニーズ
## 質問者ペルソナ（抜粋）
各医療科目ごとに、以下のニーズが存在する：
（参考：質問者ペルソナ資料 ）

* **内科**：治療方針比較・長期通院の不安解消
* **整形外科**：リハビリの実態・通院相性
* **皮膚科**：治療比較・副作用経験
* **精神科**：病院の雰囲気・初診ハードル
* **婦人科**：非公開で相談したいデリケートな内容
* **小児科**：安心できる病院選び
* **歯科**：矯正・インプラントの生体験
* **眼科**：手術体験談
* **がん診療**：体験ベースの高度医療情報（診断はNG）

共通ニーズ：
* 病院や医師の「実際の対応」を知りたい
* 通院前の不安を減らしたい
* 患者経験のリアルな声が必要

# サービス全体構成
```
質問者・回答者は共にPRサイトから登録
```
（参考：企画書「サービスの流れ（UX）」）

# 機能分類と要件
## 認証・ログイン機能
### 目的
利用者が安全にサービスを利用開始できるようにし、利用状況に応じた画面制御を可能にする。

### 対象画面
* PRサイトTOP
* OAuth選択
* 初回プロフィール登録

### 機能一覧
| No  | 機能名             |
| --- | ------------------ |
| 1   | 外部アカウント認証 |
| 2   | ログイン状態管理   |
| 3   | 初回利用者判定     |
| 4   | 権限状態の制御     |
| 5   | ログアウト処理     |

### 機能概要
#### 外部アカウント認証
利用者はGoogle、LINE などの外部サービスのアカウントを利用して認証を行う。
認証が成功した場合、サービス利用に必要な最低限の識別情報が取得される。

#### ログイン状態管理
認証後はログイン状態が維持され、連続してサービスを利用できる。
一定時間操作がない場合は自動的にログイン状態が解除される。

#### 初回利用者判定
初めてログインした利用者は、通常の利用画面に遷移せず、プロフィール登録画面へ誘導される。
必要情報が登録されるまで、質問投稿や回答機能は利用できない。

#### 権限状態の制御
利用者の状態（認証済み／未認証／登録未完了）に応じて、
利用できる画面や操作が制御される。

#### ログアウト処理
利用者は任意のタイミングでログアウトでき、ログアウト後は認証を必要とする機能が利用不可になる。

### 非機能要件
* 認証結果の成否が利用者にわかりやすく表示されること
* 複数端末からの同時ログインでも状態が破綻しないこと
* ユーザー操作に対して不自然な待機時間が発生しないこと

### 特記事項
* 認証に失敗した場合でも、再試行手段が明示されること
* 長期間ログインしていない利用者に対しては再認証を促すこと

## プロフィール管理機能
### 目的
マッチング精度とサービス体験を向上させるため、利用者情報を適切に登録・管理できるようにする。

### 対象画面
* 初回プロフィール登録
* プロフィール編集
* マイページ

### 機能一覧
| No  | 機能名                 |
| --- | ---------------------- |
| 1   | 基本プロフィール登録   |
| 2   | プロフィール表示       |
| 3   | プロフィール編集       |
| 4   | 入力内容バリデーション |
| 5   | 公開範囲制御           |

### 機能概要
#### 基本プロフィール登録
利用者はサービス利用に必要な最低限の情報（ニックネーム、地域、生まれた年、性別など）を登録できる。
登録される情報は、質問配信の対象選定や画面表示内容のカスタマイズに利用される。

#### プロフィール表示
利用者自身のプロフィール情報を画面上に一覧形式で確認できる。
実名や連絡先などの個人特定につながる情報は表示対象としない。

#### プロフィール編集
登録済みのプロフィール情報は、後から変更できる。
変更内容は保存完了後すぐに反映され、以降の利用条件に適用される。

#### 入力内容バリデーション
入力内容に不備がある場合は、保存前に利用者へ分かりやすく通知する。
未入力項目や形式不一致は明示的に表示される。

#### 公開範囲制御
プロフィール内の一部情報は、
「他ユーザーに共有される情報」と「システム内部のみ保持される情報」に分けて管理される。

### 非機能要件
* 登録・編集操作中のデータが意図せず消失しないこと
* 表示内容と保存内容に不整合が生じないこと
* 編集後の内容が即時に画面へ反映されること

### 特記事項
* プロフィール未登録の状態では質問投稿や回答は不可とする
* 年齢や性別などのセンシティブ情報については詳細な数値ではなく区分表示とする
* 個人が特定されないように実名や生年月日ではなくニックネームと生まれた年を登録する

## 質問管理機能
### 目的
利用者が悩みや疑問を投稿し、適切に管理できるようにすることで、安心して相談できる環境を提供する。
企画書で定義される2つの質問フロー（新規質問、追加質問）をサポートする。

### 対象画面
* ホーム
* LIFF 質問投稿
* LIFF 質問投稿確認
* LIFF 質問投稿完了
* LIFF 質問詳細（質問者）
* 質問詳細（公開）
* LIFF 質問一覧（自分）

### 機能一覧

| No  | 機能名                 |
| --- | ---------------------- |
| 1   | 質問作成               |
| 2   | 質問タイプ選択         |
| 3   | 質問内容確認           |
| 4   | 質問公開制御           |
| 5   | 質問一覧表示           |
| 6   | 質問詳細表示           |
| 7   | 質問ステータス管理     |
| 8   | 質問終了処理           |
| 9   | 質問履歴・スレッド管理 |

### 機能概要
#### 質問作成
利用者は LIFF を通じて自由記述で質問内容を入力し、選択肢やテンプレートを利用して投稿内容を構成できる。
質問には地域、性別条件、年齢条件などの絞り込み条件を設定できる。

#### 質問タイプ選択
質問投稿時に、以下の2つのタイプから選択できる：

| タイプ | 説明 | 対象 |
| --- | --- | --- |
| **新規質問** | 新しい相談を投稿する | マッチング対象全回答者（マルチキャスト） |
| **追加質問** | 過去の質問の続きとして追加質問を投稿する | 過去質問でマッチングした全回答者（マルチキャスト） |

#### 質問内容確認
投稿前に入力した内容を確認できる確認画面を提供する。
誤入力を防ぐため、内容の見直しができる機会を必ず設ける。

#### 質問公開制御
質問は「公開」または「非公開」を選択できる。
公開質問はマッチング対象となり、非公開質問は本人のみが閲覧可能となる。
 

#### 質問一覧表示
利用者は自分が投稿した質問を一覧形式で確認できる。
進行中・回答待ち・終了済みなどの状態が一覧上で識別できる。
質問タイプ（新規/追加）のみ表示される。

#### 質問詳細表示
質問の本文、選択肢、投稿条件、現在の状態などを詳細画面で確認できる。
質問者本人には管理用の操作ボタンが表示される。
過去の質問との関連性がわかるスレッド表示を提供する。

#### 質問ステータス管理
質問ごとに状態を管理し、画面上で確認できるようにする。

| 状態名 | 概要 |
| --- | --- |
| 下書き | 作成途中の質問 |
| 質問中 | 回答受付中の質問 |
| 回答あり | 回答が発生した質問 |
| 終了 | 受付を終了した質問 |

#### 質問終了処理
質問者は任意のタイミングで質問を終了できる「解決した」ボタンをクリックして、スレッドを手動クローズできる。
また、以下のいずれかの条件でシステムが自動的にスレッドをクローズする：
* 個別チャットのラリー回数が3往復に達する
* 最終メッセージ送信から 48 時間（または 7 日）が経過

#### 個別チャットスレッド管理
最初の回答が確定すると、「質問ID - 回答者ID」のペアで個別スレッドが確立される。
以降はこのスレッド内でのみ質問者と回答者がやり取りでき、システムが常に仲介役となる。
やり取りの内容：
* 質問者による追加質問
* 回答者による追加情報や補足
* 最大3往復までの会話に制限

### 非機能要件
* 同一操作の多重実行でも質問が重複登録されないこと
* 投稿後の内容は意図しない形で第三者に特定されないこと
* 画面表示と実データの状態が一致していること
* ラリー回数が正確にカウントされ、3往復に達すると必ずクローズされること
* 自動クローズのタイマーが正確に動作すること（48時間または7日）

### 特記事項
* 医療関連の内容については注意喚起表示を常に行う
* **送信前の AI チェック**：回答者が自由記述（100-140文字）を送信する際、LLM を使用して以下を自動判定・フィルタリングする
  * 診断行為（「△△の可能性が高い」など）
  * 断定的な治療効果の言及（「こうすれば治る」など）
  * 誹謗中傷や不適切表現
  * 判定結果に基づいて修正を促すメッセージを表示
* 質問は新規と追加の2タイプのみ。

## マッチング機能
### 目的
質問者の投稿内容に対して、適切な回答者を選定し、効率的に質問を届けることで回答率と品質を高める。
企画書で定義される2つの質問フロー（新規質問、追加質問）に対応したマッチングを実現する。

### 対象画面
* ホーム
* LIFF 質問詳細（質問者）
* LINE DM（回答者 - 通知受信）

### 機能一覧
| No  | 機能名                   |
| --- | ------------------------ |
| 1   | 回答者候補の抽出         |
| 2   | 質問配信制御             |
| 3   | 再マッチング制御         |
| 4   | マッチング状態管理       |
| 5   | マッチング解除           |

### 機能概要
#### 回答者候補の抽出
質問が投稿されると、質問内容のカテゴリ、地域、性別条件、年齢条件などをもとに、条件に合致する回答者候補を抽出する。
回答可能状態（離脱中・制限中は除外）のユーザーのみが対象となる。

#### 質問配信制御
抽出された候補の中から、**一度に配信する人数を制限**して質問を LINE を通じて通知する。
配信人数はシステム側で制御可能とし、回答負荷の集中を防ぐ。

#### 再マッチング制御
一定時間内に回答が得られなかった場合、次の候補グループへ質問を再配信する。
この処理は自動で行われ、質問者の操作は不要とする。

#### マッチング状態管理
質問ごとに以下のような状態を管理する。

| 状態名   | 概要                              |
| -------- | --------------------------------- |
| 未マッチ | まだ候補抽出のみ行われた状態      |
| 配信中   | 回答候補者に配信されている状態    |
| 回答あり | 少なくとも1件の回答が行われた状態 |
| 終了     | 質問者によりクローズされた状態    |

#### マッチング解除
以下の条件でマッチングは解除される。
* 質問者が質問を終了した場合
* 既定の最大配信回数に達した場合
* 一定期間が経過した場合

解除後は新たな回答受付は行わない。

### 非機能要件
* 大量の同時投稿時でもマッチング処理が滞らないこと
* 回答者側には通知が過剰に集中しないよう調整されること
* 状態遷移が画面に即時反映されること
* 質問配信は正確にターゲティングされ、回答者への通知負荷を低減すること
* 送信前に AI チェック（NGワード、診断行為、誹謗中傷検出）を行うこと

### 特記事項
* 回答者の負荷状況（過去の回答回数、直近の稼働状況）を考慮して配信優先度を調整できるようにする
* マッチングロジックは将来的なチューニングを前提に拡張余地を持たせる
* 追加質問は「新規質問」と同じマッチングロジックで全回答者に配信される

## 回答管理機能
### 目的
回答者が質問に対して適切な回答を行い、その履歴を安全に管理できる環境を提供する。

### 対象画面
* 質問詳細（回答者 - LIFF/読み取り専用表示）
* LINE DM（回答者 - 実際の回答の入力）
* 回答一覧（回答者 - Webアプリ）

### 機能一覧

| No  | 機能名             |
| --- | ------------------ |
| 1   | 質問通知受信       |
| 2   | 質問内容確認       |
| 3   | 選択肢選択         |
| 4   | 場所情報入力       |
| 5   | URL情報入力        |
| 6   | 回答完了           |
| 7   | 回答履歴管理       |
| 8   | 回答ステータス管理 |

### 機能概要
#### 質問通知受信
マッチング対象となった回答者に対して、LINE を通じて質問内容が通知される。
通知にはリッチメニュー或いはボタン形式で、簡単に質問内容を開けるよう設計される。

#### 質問内容確認
回答者は LINE のチャット内で質問の詳細内容を確認できる。
質問テンプレート、選択肢、投稿条件などが表示される。

#### 選択肢選択
質問に設定されている選択肢から、該当する回答を選択できる（LINE の Flex Message ボタンで実装）。

#### 場所情報入力
回答に関連する場所（病院名など）を、地図アプリまたは地域検索機能で指定できる。
外部連携を活用した実装を検討する。

#### URL情報入力
参考になるサイトやリソースの URL を入力・添付できる。

#### 回答入力フォーマット
* 回答者は LINE DM で `選択肢 + 場所 + URL + 短文(100-140文字)` を送信します。
* 送信前に AI チェック（NGワード、診断行為、誹謗中傷検出）を実行し、違反時はブロックまたは警告を出します。

#### 回答完了
回答内容（選択肢+場所+URL+短文）が送信されると、LINE上で完了メッセージが表示される。
同時に Webアプリ内でも回答履歴が記録される。

#### 回答履歴管理
Webアプリの「マイページ」内で、自身が過去に行った回答を一覧形式で確認できる。
進行中の質問と終了済みの質問は区別して表示される。

#### 回答ステータス管理

| 状態名       | 概要                                     |
| ------------ | ---------------------------------------- |
| 配信待ち     | LINEに通知が配信されるのを待っている状態 |
| 未回答       | 通知を受け取ったが、まだ回答していない状態 |
| 回答済       | 回答を送信済みの状態                     |
| クローズ     | 質問が終了し、回答不可となった状態       |

### 非機能要件
* LINE経由の回答送信の失敗時に、再試行できる仕組みを提供すること
* 回答データは即座にWebアプリの履歴に反映されること
* 同一質問への二重回答が発生しないこと
* 他ユーザーの質問情報が不正に閲覧できないこと
### 特記事項
* 回答フローは LINE の外部アプリ内で完結し、Webアプリへの戻りは不要とする
* 回答は短文（100-140文字）で扱う
* 医療的助言については、送信前にガイダンスを表示する
* 回答内容は送信後に編集不可とする
* LINE の API 仕様変更に備えた抽象化レイヤーを設ける
* 医療的助言については、送信前にガイダンスを表示する
* 回答内容は送信後に編集不可とする
* LINE の API 仕様変更に備えた抽象化レイヤーを設ける

## 外部サービス連携機能（LINE 統合）
### 目的
LINE の外部サービスを利用して、質問・回答に関する通知およびメッセージの受け渡しを行い、
システム外チャネルを通じた安全かつ効率的なコミュニケーションを実現する。

### 対象画面
## 外部サービス連携機能（LINE Messaging API）
### 目的
LINE Messaging API を利用して、質問・回答に関する通知およびメッセージの受け渡しを行い、
LINE DM を通じた安全かつ効率的なコミュニケーションを実現する。
企画書で定義される「回答」フローを LINE DM の Flex Message 内で実装する。

### 対象画面
* LIFF 質問投稿（質問者）
* LINE DM（回答者 - 実際の回答入力）
* LIFF マイページ（質問者 - LINE 通知確認）

### 機能一覧

| No  | 機能名                     |
| --- | -------------------------- |
| 1   | LINE アカウント連携管理     |
| 2   | 質問通知配信（回答者向け）  |
| 3   | 回答入力インターフェース   |
| 4   | 回答通知配信（質問者向け）  |
| 5   | メッセージ中継制御         |
| 6   | 配信ログ管理               |
| 7   | NGワード・診断行為チェック |

### 機能概要
#### LINE アカウント連携管理
利用者は LINE のアカウントを本システムと連携させることができる。
連携情報はユーザー単位で管理され、通知の受け取りに使用される。
LINE 連携は認証時に行われ、その後の質問・回答フローに必須となる。

#### 質問通知配信（回答者向け）
マッチング対象となった回答者に対して、LINE DM を通じて質問内容の通知が配信される（マルチキャスト）。
通知には以下の情報が含まれる：
* 質問の要約
* 選択肢一覧（最大6個）
* 場所情報が必要か否か
* URL 情報が必要か否か

通知は LINE Bot を通じて Flex Message 形式で配信され、リッチな UI を提供する。

#### 回答入力インターフェース
LINE DM 内で、回答者が以下の操作を行えるインターフェースが提供される：
* 選択肢のワンタップ選択（ButtonTemplate）
* 場所情報の入力（テキスト入力または地図アプリリンク）
* URL 情報の貼り付け
* 短文（100-140文字推奨）の自由記述
これらは LINE Flex Message（リッチメニュー）で実装される。

#### 回答通知配信（質問者向け）
回答が送信された際に、質問者の LINE アカウントに DM 通知が配信される。
回答内容（選択肢、場所、URL、短文）が構造化テキスト形式で通知に含まれる。
一度回答が確定すると、以後はシステムが個別スレッドを確立し、
質問者と回答者は 1 対 1 の個別チャットで追加のやり取りができる。

#### メッセージ中継制御
質問者と回答者間のメッセージは、必ずシステムを経由して LINE に送信される。
LINE 上での直接的なユーザー同士の接続は行わない。
個人情報（実名、電話番号等）の抽出を防ぐため、メッセージは事前にフィルタリングされる。

#### 配信ログ管理
LINE API への送信履歴・配信結果をログとして保存し、障害時の追跡を可能とする。
配信失敗時の再試行ロジックを実装する。

#### NGワード・診断行為チェック
回答者が短文（100-140文字）を送信する際、送信前に **LLM を使用した AI 診断**を実施する：
* **診断行為の検出**：「△△の可能性がある」「〇〇症かもしれません」など、医学的診断に該当する表現
* **断定的な治療効果**：「これで治ります」「確実に効く」など、治療効果の断定
* **誹謗中傷・不適切表現**：人身攻撃、差別的表現など
判定結果に基づいて修正を促すメッセージを表示し、ユーザーが修正して再送信できるようにする
### 非機能要件
* LINE API 障害時にシステムが停止しないこと（キューイングによる遅延対応）
* 配信順序が保証されること
* 他ユーザー宛の通知が誤配信されないこと
* AI チェック処理が 1 秒以内に完了すること（UX 維持）
* NGワードチェックでの誤検知を最小化するため、継続的に LLM を精緻化する
* LINE の API 仕様変更に柔軟に対応できる設計であること

### 特記事項
* 通知本文には個人情報を含めない設計とする
* LINE Messaging API の Push API（マルチキャスト）を使用した一斉通知を基本とする
* LINE 連携は認証フローに統合され、ユーザーが LINE アカウントを連携していないと質問投稿や回答が不可となる
* 回答フロー（選択肢 + 場所 + URL + 短文）は LINE DM の Flex Message 内で完結
* 短文（100-140文字）は AI でチェック後、修正を促し、その後システムに送信される
* 一度回答が確定すると、システムは「質問ID - 回答者ID」の個別スレッドを確立
* 個別スレッド内での会話は最大3往復に制限される（LINE Push API コスト削減）

## 一覧・検索機能
### 目的
利用者が大量の情報の中から必要な質問や回答を効率的に見つけられるようにする。

### 対象画面
* ホーム
* 質問一覧（自分）
* 回答一覧（回答者）

### 機能一覧
| No  | 機能名         |
| --- | -------------- |
| 1   | 一覧表示       |
| 2   | 状態別フィルタ |
| 3   | 並び替え       |
| 4   | 検索条件指定   |
| 5   | 検索結果表示   |

### 機能概要
#### 一覧表示
質問や回答をカード形式またはリスト形式で一覧表示する。
各項目には状態（募集中、回答済、終了済など）が視覚的に表示される。

#### 状態別フィルタ
進行中・未回答・終了済みなどの状態ごとに表示内容を絞り込める。

#### 並び替え
新着順、更新順などで表示順を変更できる。

#### 検索条件指定
キーワード、カテゴリ、地域などの条件を指定して検索できる。

#### 検索結果表示
条件に一致した質問・回答のみを一覧に表示する。

### 非機能要件
* 件数が多い場合でも表示が著しく遅延しないこと
* 検索結果が安定して表示されること
* 同一条件で同じ結果が取得できること

### 特記事項
* 公開範囲外の情報は検索対象外とする
* 利用者の権限状態に応じて表示対象を制御する

## マイページ機能
### 目的
利用者自身の活動状況を可視化し、サービスの利用状況を直感的に把握できるようにする。

### 対象画面
* マイページ
* ホーム

### 機能一覧

| No  | 機能名             |
| --- | ------------------ |
| 1   | アクティビティ表示 |
| 2   | ステータス可視化   |
| 3   | 履歴導線提供       |
| 4   | 設定導線提供       |
|     |                    |

### 機能概要
#### アクティビティ表示
自分が投稿した質問数、回答数などを集計して表示する。

#### ステータス可視化
質問の進行状況をアイコンやラベルで分かりやすく表現する。

#### 履歴導線提供
過去の質問一覧、回答一覧、チャット履歴への遷移リンクを提供する。

#### 設定導線提供
プロフィール編集、通知設定、利用規約などへの導線をまとめて表示する。

### 非機能要件
* 画面表示が一定時間以内に完了すること
* 情報が最新状態で表示されること
* 他ユーザーの情報が混在しないこと

### 特記事項
* 表示内容はログインユーザーごとに完全に分離される
* 未ログイン状態ではアクセス不可とする

## 設定・規約機能

### 目的
利用者がサービス利用に必要な各種設定を行い、ルールや方針を適切に理解できるようにする。

### 対象画面
* 設定
* 利用規約
* プライバシー
* 退会画面

### 機能一覧

| No  | 機能名       |
| --- | ------------ |
| 1   | 各種設定表示 |
| 2   | 設定内容変更 |
| 3   | 規約閲覧     |
| 4   | 同意管理     |
| 5   | 退会手続き   |

### 機能概要
#### 各種設定表示
利用者はアカウント関連設定や通知設定、表示設定などを一覧で確認できる。

#### 設定内容変更
各種設定項目のオン／オフや選択内容を変更できる。
変更後の内容は即時に反映される。

#### 規約閲覧
利用規約およびプライバシーポリシーの内容を専用画面で閲覧できる。

#### 同意管理
サービス利用に必要な規約への同意状態を管理し、未同意の場合は利用制限を行う。

#### 退会手続き
利用者は任意のタイミングで退会できる。
退会後はアカウント情報および投稿データの取り扱い方針に従って処理される。

### 非機能要件
* 設定変更による誤動作が発生しないこと
* 規約表示が途中で途切れないこと
* 退会処理が不完全な状態で止まらないこと

### 特記事項
* 退会後のデータ保持期間や範囲は別途運用規程に従う
* 法令改定時は規約内容の更新を行う