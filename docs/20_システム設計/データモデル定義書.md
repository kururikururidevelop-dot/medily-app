# データモデル定義書

本書は本システムのデータモデル（Firestore を想定）を定義する。カテゴリ等の「システム定義マスタ」は専用コレクションに格納し、運用で管理・変更できる前提で設計する。

## 目次
- 概要
- マスタ（参照データ）設計
- コアコレクション設計
  - users
  - questions
  - answers
  - threads
  - categories
  - favorites
- サンプルドキュメント
- インデックス（検索・フィルタ用）
- 非機能要件（スケーラビリティ・一貫性）
- 運用・バッチ（TTL・クローズルール）
- セキュリティ（Firestore ルール・最小権限）
- バックアップ / 保守

---

## 概要
- ストレージ: Cloud Firestore（ドキュメント型 DB）を想定。大きなバイナリは Cloud Storage に格納し、URL を Firestore に保存。
- 設計方針:
  - 読み取りが多いデータは denormalize（カウンタや集計）を実装してレスポンスを高速化。
  - 書き込みはトランザクション/バッチで整合性を保つ（例: 回答追加時のカウンタ更新）。
  - マスタデータ（カテゴリ、テンプレート等）は頻繁に変わらないため別コレクションで管理。

---

## マスタ（参照データ）設計

### `categories`（カテゴリマスタ）
- 用途: 質問カテゴリ（皮膚科等）の定義
- ドキュメント例（id = `dermatology`）:
```json
{
  "id": "dermatology",
  "name": "皮膚科",
  "parentId": null,
  "order": 10,
  "active": true,
  "description": "皮膚科全般に関する投稿カテゴリ",
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-06-01T00:00:00Z"
}
```
- 注意: 階層構造が必要な場合は `parentId` でツリー管理。
- アクセス: 公開参照可。管理UIで作成/更新。



---

## コアコレクション設計

### `users`（利用者）
- 用途: 質問者 / 回答者のアカウント情報
- 主キー: uid (Auth uid / LINE userId)
- フィールド:
  - id: string (Document ID matches uid)
  - displayName: string
  - region: string
  - categories: array of strings (選択したカテゴリ名)
  - medicalBackground: string (optional)
  - avatar: string (Internal Firestore field for avatar)
  - pictureUrl: string (LINE profile image URL)
  - gender: string (optional, e.g., "male", "female", "other")
  - birthYear: string (optional)
  - notificationConsent: boolean (optional)
  - isProfileCompleted: boolean
  - profileCompletedAt: timestamp
  - rank: number (default: 0)
  - primaryCategory: string (deprecated, backward compatibility)
  - createdAt, updatedAt
- インデックス: uid (自動), categories

### `questions`（質問）
- 用途: 質問メタデータ
- スキーマ:
  - id: string (Firestore auto id)
  - userId: string (質問者ID, matches authorId logic)
  - parentQuestionId: string (optional) (追加質問の場合、元の質問ID)
  - title: string (質問タイトル、必須、最大60文字)
  - description: string (質問本文・詳細内容)
  - region: string (地域)
  - categories: array of strings (カテゴリ名)
  - choices: array of strings (選択肢)
  - isPublic: boolean (公開レベル)
  - status: enum ('matching', 'waiting_for_answer', 'answered', 'matching_failed')
  - genderFilter: enum ('male', 'female', 'none') (optional)
  - ageGroups: array of strings (optional) (年代フィルタ)
  - answerCount: number (denormalized)
  - createdAt, updatedAt (Timestamp)
  - postedAt: Timestamp (公開/投稿日時)
  - closedAt: Timestamp (optional) (クローズ日時)
  - authorName: string (denormalized)
  - authorAvatarUrl: string (denormalized)
- 実装上の注意:
  - `title` は冒頭・一覧表示に使用するため必須。
  - 以前の `body` フィールドは `description` に統合。
  - `status` はシステムの状態遷移を厳密に管理する。
- インデックス: status, postedAt DESC, userId, categories

### `questions/{questionId}/answers`（回答：サブコレクション）
- 用途: 各質問に対する回答を格納
- スキーマ:
  - id: string
  - userId: string (回答者ID)
  - content: string (回答本文)
  - choices: array of strings (選択した選択肢)
  - answeredAt: Timestamp (optional)
  - authorName: string (denormalized)
  - authorAvatarUrl: string (denormalized)
  - createdAt, updatedAt
- 備考: 回答が投稿されると、親 `questions` の `answerCount` および `status` が更新される。
- インデックス: userId, createdAt

**代替案:** トップレベル `answers` コレクションを使う場合は `questionId` を持たせ、質問単位でクエリするために `questionId + createdAt` の複合インデックスを作成

### `threads`（個別チャットスレッド）※任意／設計上は `questionId + responderId` をユニークキー
- 用途: 質問者と個別に続くやり取り（3ラリー制限の管理）
- スキーマ例:
  - id: string (questionId_responderId)
  - questionId: string
  - responderId: string
  - messages: array (最新数件のキャッシュ) / or サブコレクション `threads/{id}/messages`
  - rounds: number (往復数)
  - status: enum (open/closed)
  - lastMessageAt
- 備考: 実運用では `threads/{id}/messages` をサブコレクションにし、`rounds` はトランザクションで管理

### `users/{userId}/favorites`（お気に入り）
- 用途: ユーザーが保存した質問（ブックマーク）
- スキーマ:
  - id: string (questionId)
  - questionId: string
  - addedAt: Timestamp




---

## サンプルドキュメント（抜粋）

### 質問（questions）
```json
{
  "id": "abc123",
  "userId": "user_01",
  "parentQuestionId": null,
  "title": "発熱が続くときの受診目安は？",
  "description": "高熱が続くのですが、受診の目安はありますか？",
  "categories": ["internal_medicine"],
  "choices": ["選択肢A", "選択肢B"],
  "region": "kanto",
  "genderFilter": "none",
  "ageGroups": [],
  "isPublic": false,
  "status": "matching",
  "answerCount": 1,
  "createdAt": "2025-12-12T05:00:00Z",
  "postedAt": "2025-12-12T05:00:00Z",
  "closedAt": "2025-12-14T05:00:00Z"
}
```

### 回答（questions/{id}/answers）
```json
{
  "id": "ans_001",
  "userId": "user_10",
  "choices": ["選択肢A"],
  "content": "私も同様の経験があります。受診をおすすめします。",
  "answeredAt": "2025-12-12T05:10:00Z",
  "createdAt": "2025-12-12T05:10:00Z"
}
```

---

## インデックス（Firestore）
- 質問一覧（新着）: `questions` collection, index on (`status`, `postedAt DESC`)
- 質問履歴（ユーザー）: `questions` where `userId == X` order by `postedAt DESC`
- 回答一覧（質問内）: `questions/{id}/answers` order by `createdAt ASC` (or DESC)
- 回答者別履歴: `answers` (top-level collectionGroup) where `userId == X` order by `createdAt DESC`
- キーワード検索: クライアントサイドフィルタまたは `title`/`description` に対する全文検索ソリューション（Algolia等）の導入検討

---

## 非機能要件（スケーラビリティ・一貫性）
- 回答数やユーザー数の増加に備え、カウンタ更新は分散トランザクションで実施。
- Hotspot を避けるため、頻繁更新されるカウンタは sharding パターンを検討（必要時）。
- 読み取りが多い集計データは denormalize して返却を高速化（例: contributions、question.answerCount）

---

## 運用・バッチ（TTL・クローズ処理）
- 自動クローズ: 質問は `closeAt` を設定し、Cloud Scheduler + Cloud Functions で定期実行してクローズ処理を行う（48 時間ルールや 7 日ルールに応じて設定）
- 集計バッチ: 日次/週次集計で `contributions` を整備
- 画像生成: 高負荷のグラフィック生成（E020 用 PNG）は Cloud Run または Cloud Functions + Puppeteer/Sharp で行い Cloud Storage に保存

---

## セキュリティ（Firestore ルール & 監査）
- 基本方針: 最小権限。読み書きはユーザーの UID とドキュメントの authorId を比較して制限
- 例: `questions/{id}` の更新は `request.auth.uid == resource.data.authorId` または特権ユーザーのみ
- 回答は `questions/{id}/answers` の `create` を認可したユーザーのみ（マッチング済みの回答者かどうかは Functions 側で判定）
- 管理操作は `audits` にログを残す

---

## バックアップ / 保守
- 定期エクスポート: Firestore Export（daily/weekly）を Cloud Storage に保存
- 重要データ保持ポリシー: 個人情報や医療情報は法令および社内ポリシーに従い保管・消去

---

## 備考
- マスタ（カテゴリ・テンプレ）に関する変更は UI/管理画面での履歴管理（バージョン）を推奨
- 実際の実装ではトラフィック・コストを見ながら一部設計（トップレベル answers vs subcollection）を見直す
