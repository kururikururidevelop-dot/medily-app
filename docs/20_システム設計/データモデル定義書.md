# データモデル定義書

本書は本システムのデータモデル（Firestore を想定）を定義する。カテゴリ等の「システム定義マスタ」は専用コレクションに格納し、運用で管理・変更できる前提で設計する。

## 目次
- 概要
- マスタ（参照データ）設計
- コアコレクション設計
  - users
  - questions
  - answers
  - threads
  - contributions / summary
  - thank_counts（任意）
  - categories
  - templates
  - notifications
  - audits / logs
  - assets（画像）
- サンプルドキュメント
- インデックス（検索・フィルタ用）
- 非機能要件（スケーラビリティ・一貫性）
- 運用・バッチ（TTL・クローズルール）
- セキュリティ（Firestore ルール・最小権限）
- バックアップ / 保守

---

## 概要
- ストレージ: Cloud Firestore（ドキュメント型 DB）を想定。大きなバイナリは Cloud Storage に格納し、URL を Firestore に保存。
- 設計方針:
  - 読み取りが多いデータは denormalize（カウンタや集計）を実装してレスポンスを高速化。
  - 書き込みはトランザクション/バッチで整合性を保つ（例: 回答追加時のカウンタ更新）。
  - マスタデータ（カテゴリ、テンプレート等）は頻繁に変わらないため別コレクションで管理。

---

## マスタ（参照データ）設計

### `categories`（カテゴリマスタ）
- 用途: 質問カテゴリ（皮膚科等）の定義
- ドキュメント例（id = `dermatology`）:
```json
{
  "id": "dermatology",
  "name": "皮膚科",
  "parentId": null,
  "order": 10,
  "active": true,
  "description": "皮膚科全般に関する投稿カテゴリ",
  "createdAt": "2025-01-01T00:00:00Z",
  "updatedAt": "2025-06-01T00:00:00Z"
}
```
- 注意: 階層構造が必要な場合は `parentId` でツリー管理。
- アクセス: 公開参照可。管理UIで作成/更新。

### `templates`（質問テンプレート）
- 用途: 質問テンプレート（文面/選択肢セット）
- スキーマ: id, title, body, choices[], categoryId, author, active, createdAt, updatedAt

### `thank_templates`（サンキュー定型文）※任意
- 用途: 質問者が回答者に送る感謝テンプレート（UIで評価表現）

---

## コアコレクション設計

### `users`（利用者）
- 用途: 質問者 / 回答者のアカウント情報
- 主キー: uid (Auth uid / LINE userId)
- フィールド（例）:
  - uid: string
  - displayName: string
  - avatarUrl: string
  - nickname: string
  - region: string
  - roles: array (e.g., ["responder"])
  - isResponder: boolean
  - categories: array of category ids (初回プロフィール登録で選択した複数カテゴリ)
  
  - contributionScore: number (denormalized)
  - thankCount: number (denormalized)
  - createdAt, updatedAt
- インデックス: uid (自動), categories, isResponder

### `questions`（質問）
- 用途: 質問メタデータ
- スキーマ（例）:
  - id: string (Firestore auto id)
  - authorId: string (ユーザー uid)
  - parentQuestionId: string (optional) (追加質問の場合、元の質問ID)
  - title: string (質問タイトル、必須、最大60文字)
  - body: string / description: string (質問本文・詳細内容)
  - categoryId: string (カテゴリID：基本診療科/症状別など）
  - choices: array (max 6) (選択肢)
  - region: string (地域)
  - public: boolean (公開レベル)
  - status: enum (draft, open, answered, closed) (質問ステータス)
  - matchedResponderIds: array (マッチングで通知した回答者 ID のスナップショット)
  - answerCount: number (denormalized) (回答数)
  - createdAt, updatedAt (タイムスタンプ)
  - closeAt: timestamp (for auto-close) (自動クローズ時刻)
  - genderFilter: enum (all, male, female) (optional) (性別フィルタ条件)
  - ageFilter: string (optional) (年齢フィルタ条件: 20s, 30s, 40s, 50s)
- 実装上の注意:
  - `title` は冒頭・一覧表示に使用するため必須。前後の空白を trim し、60文字を超えたらバリデーションエラーを返す。
  - `body` または `description` フィールドで質問本文を格納。API では `description` を使用する場合もある。統一を推奨。
- 備考: `answers` は `questions/{id}/answers` のサブコレクション、またはトップレベル `answers` コレクションを採用可能（後述）
- インデックス: authorId, status, categoryId, createdAt

### `questions/{questionId}/answers`（回答：サブコレクション）
- 用途: 各質問に対する回答を格納
- スキーマ（例）:
  - id: string
  - responderId: string
  - choice: string (selected choice id)
  - location: string
  - url: string
  - text: string (短文 100-140 文字)
  - aiCheck: { result: pass|flagged, reasons: [] }
  - createdAt, updatedAt
- 備考: 回答が投稿されると、親 `questions` の `answerCount` をトランザクションでインクリメントし、必要なら `contributions` を更新
- インデックス: responderId, createdAt

**代替案:** トップレベル `answers` コレクションを使う場合は `questionId` を持たせ、質問単位でクエリするために `questionId + createdAt` の複合インデックスを作成

### `threads`（個別チャットスレッド）※任意／設計上は `questionId + responderId` をユニークキー
- 用途: 質問者と個別に続くやり取り（3ラリー制限の管理）
- スキーマ例:
  - id: string (questionId_responderId)
  - questionId: string
  - responderId: string
  - messages: array (最新数件のキャッシュ) / or サブコレクション `threads/{id}/messages`
  - rounds: number (往復数)
  - status: enum (open/closed)
  - lastMessageAt
- 備考: 実運用では `threads/{id}/messages` をサブコレクションにし、`rounds` はトランザクションで管理

### `contributions`（回答者集計コレクション）
- 用途: 回答者ごとの集計データ（E020 の表示ソース）
- スキーマ例（ドキュメント id = uid）:
  - uid
  - totalAnswers: number
  - thankCount: number
  - categories: { categoryId: { count: number } }
  - score: number
  - badges: array
  - updatedAt
- 備考: 回答受信時にトランザクションで更新。重い集計はバッチで更新

### `thank_counts`（任意）
- 用途: 質問者からの「サンキュー」（感謝）履歴を管理（サンキューの詳細や履歴可視化が必要な場合）
- スキーマ（サブコレクション）: `users/{uid}/thanks/{thankId}`
  - id
  - fromUserId
  - toUserId
  - questionId
  - message
  - createdAt

### `notifications`（配信履歴）
- 用途: LINE への Push/通知履歴、送信結果の監査
- フィールド:
  - id
  - targetUserId
  - payloadType
  - payload
  - status (sent/failed)
  - error
  - sentAt

### `assets`（画像等）
- 用途: ローカル保存または Cloud Storage の参照メタデータ
- フィールド:
  - id
  - path
  - url
  - contentType
  - size
  - createdAt

### `audits` / `logs`
- 用途: 重要イベント（質問作成、回答削除、管理者操作）の履歴
- フィールド: actorId, action, targetId, details, createdAt

---

## サンプルドキュメント（抜粋）

### 質問（questions）
```json
{
  "id": "abc123",
  "authorId": "user_01",
  "parentQuestionId": null,
  "title": "発熱が続くときの受診目安は？",
  "body": "高熱が続くのですが、受診の目安はありますか？",
  "categoryId": "internal_medicine",
  "choices": ["選択肢A", "選択肢B"],
  "region": "kanto",
  "genderFilter": "all",
  "ageFilter": "",
  "allowLocation": true,
  "allowUrl": true,
  "public": false,
  "status": "open",
  "matchedResponderIds": ["user_10", "user_11"],
  "answerCount": 1,
  "createdAt": "2025-12-12T05:00:00Z",
  "closeAt": "2025-12-14T05:00:00Z"
}
```

### 回答（questions/{id}/answers）
```json
{
  "id": "ans_001",
  "responderId": "user_10",
  "choice": "選択肢A",
  "location": "東京医科大学附属病院",
  "url": "https://example.com",
  "text": "私も同様の経験があります。受診をおすすめします。（120文字）",
  "aiCheck": {"result":"pass","reasons":[]},
  "createdAt": "2025-12-12T05:10:00Z"
}
```

### contributions（集計）
```json
{
  "uid": "user_10",
  "totalAnswers": 123,
  "thankCount": 24,
  "categories": {"dermatology": 50, "internal_medicine": 20},
  "score": 420,
  "badges": ["初回回答","100回答達成"],
  "updatedAt": "2025-12-12T06:00:00Z"
}
```

---

## インデックス（Firestore）
- 質問一覧（新着）: `questions` collection, index on (`status`, `createdAt DESC`)
- 質問履歴（ユーザー）: `questions` where `authorId == X` order by `createdAt DESC`
- 回答一覧（質問内）: `questions/{id}/answers` order by `createdAt DESC`
- 回答者別履歴: `answers` (top-level) where `responderId == X` order by `createdAt DESC` (requires composite index if combined with other filters)
- 貢献度クエリ: `contributions/{uid}` direct read（キャッシュ・読み取りが多いため読み取り最適化）

---

## 非機能要件（スケーラビリティ・一貫性）
- 回答数やユーザー数の増加に備え、カウンタ更新は分散トランザクションで実施。
- Hotspot を避けるため、頻繁更新されるカウンタは sharding パターンを検討（必要時）。
- 読み取りが多い集計データは denormalize して返却を高速化（例: contributions、question.answerCount）

---

## 運用・バッチ（TTL・クローズ処理）
- 自動クローズ: 質問は `closeAt` を設定し、Cloud Scheduler + Cloud Functions で定期実行してクローズ処理を行う（48 時間ルールや 7 日ルールに応じて設定）
- 集計バッチ: 日次/週次集計で `contributions` を整備
- 画像生成: 高負荷のグラフィック生成（E020 用 PNG）は Cloud Run または Cloud Functions + Puppeteer/Sharp で行い Cloud Storage に保存

---

## セキュリティ（Firestore ルール & 監査）
- 基本方針: 最小権限。読み書きはユーザーの UID とドキュメントの authorId を比較して制限
- 例: `questions/{id}` の更新は `request.auth.uid == resource.data.authorId` または特権ユーザーのみ
- 回答は `questions/{id}/answers` の `create` を認可したユーザーのみ（マッチング済みの回答者かどうかは Functions 側で判定）
- 管理操作は `audits` にログを残す

---

## バックアップ / 保守
- 定期エクスポート: Firestore Export（daily/weekly）を Cloud Storage に保存
- 重要データ保持ポリシー: 個人情報や医療情報は法令および社内ポリシーに従い保管・消去

---

## 備考
- マスタ（カテゴリ・テンプレ）に関する変更は UI/管理画面での履歴管理（バージョン）を推奨
- 実際の実装ではトラフィック・コストを見ながら一部設計（トップレベル answers vs subcollection）を見直す
