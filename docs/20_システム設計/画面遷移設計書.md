# 画面遷移設計書

## 初期導線

```
[A010: PRサイトTOP]
   ├── 会員登録 → [A020: OAuth選択]
   ├── ログイン → [A020: OAuth選択]
   └── 回答してみる → [A041: 質問一覧（公開）]

[A041: 質問一覧（公開）]
   └── 回答ボタン（仮） → [A020: OAuth選択]


[A020: OAuth選択]
   └── LINE認証成功
         ├── 初回 → [A030: 初回プロフィール登録]
         └── 既存 → [A040: ホーム]

[A030: 初回プロフィール登録]
   └── 登録完了 → [A040: ホーム]
```

## ホーム画面（A040）からの遷移

```
[A040: ホーム]
├── 質問投稿 → [L010: 質問投稿(LIFF)]
├── 自分の質問 → [E010: 質問一覧（自分）]
├── 自分の回答 → [E020: 回答一覧（自分）]
├── マイページ → [D010: マイページ]
└── 設定 → [F010: 設定]
```

## 質問投稿フロー（LIFF）

### 新規質問・追加質問フロー
```
[L010: 質問投稿(LIFF)]
   ├── 質問タイプ選択
   │   ├── 新規質問選択 → [L010: 質問内容入力]
   │   └── 追加質問選択 → 過去質問選択ステップ → [L010: 質問内容入力]
   ├── 確認 → [L011: 質問投稿確認(LIFF)]
   └── キャンセル → [A040: ホーム]

[L011: 質問投稿確認(LIFF)]
   ├── 投稿 → [L012: 質問投稿完了(LIFF)]
   └── 修正 → [L010: 質問投稿(LIFF)]

[L012: 質問投稿完了(LIFF)]
   └── ホームへ戻る → [A040: ホーム]
```

**補足**
* 新規質問：すべてのマッチング対象回答者へ LINE DM で配信
* 追加質問：新規質問でマッチングした全回答者へ LINE DM で配信
* 質問は最大3往復（3ラリー制限）で自動クローズされる
* 質問投稿時に AI チェック（NGワード、診断行為、誹謗中傷）を実行し、違反検出時は投稿不可
* 質問投稿後、LINE Bot から回答者へ Flex Message で質問通知を Push 配信

## 質問閲覧フロー

### 自分の質問（LIFF）

```
[E010: 質問一覧（自分）]
   └── 質問選択 → [L020: 質問詳細・回答確認(LIFF)]
```

### 公開質問（Web）

```
[A040: ホーム]
   └── 公開質問選択 → [B022: 質問詳細（公開）]
```

## 質問詳細・回答確認（LIFF）

```
[L020: 質問詳細・回答確認(LIFF)]
├── 回答内容表示（LINE DM から受信した回答を表示）
│   ├── 選択肢
│   ├── 場所情報
│   ├── URL
│   └── 短文（100-140文字）
├── 追加質問送信 → [L010: 質問投稿(LIFF)]
├── マイページ → [L030: マイページ(LIFF)]
└── 戻る → [E010: 質問一覧（自分）]
```

**補足：回答フロー（LINE DM 内で完結）**
* システムが回答者にマッチング後、LINE DM へ Flex Message で質問通知を配信
* 回答者が LINE DM 内でボタンをタップして：
   * 選択肢を確定
   * 場所情報を入力
   * URL を添付
   * 短文コメント（100-140文字）を入力
* 送信前に AI チェック（NGワード、診断行為、誹謗中傷検出）を実行
* LINE Messaging API webhook でシステムがメッセージを受信・保存
* システムが LINE Push API で質問者に LINE DM で回答を配信
* 質問者が LIFF でメッセージを確認

## 回答者動線

```
[L020: 質問詳細・回答確認(LIFF)]
├── LINE DM で質問通知を受け取り
├── LINE DM 内（Flex Message）で回答を操作
│   ├── ボタンタップで選択肢選択
│   ├── テキスト入力で場所情報・URL入力
│   └── テキスト入力で短文コメント入力
└── システムが LINE から受信して管理
```

## マイページ（LIFF）

```
[L030: マイページ(LIFF)]
├── プロフィール概要表示
├── 投稿質問一覧表示
├── プロフィール編集 → [D020: プロフィール編集(Web)]
├── 設定 → [F010: 設定(Web)]
└── ホームへ戻る → [A040: ホーム(Web)]
```

## マイページ・設定系（Web）

```
[D010: マイページ(Web)]
├── プロフィール編集 → [D020]
├── 通知設定 → [D030]
├── 設定 → [F010]
└── 戻る → [A040]

[D020: プロフィール編集]
   └── 保存 → [D010]

[D030: 通知設定]
   └── 保存 → [D010]
```

## 履歴閲覧（Web）

```
[E020: 回答一覧（自分）]
   └── 回答選択 → [質問詳細を LIFF で表示]
```

## 設定系画面（Web）

```
[F010: 設定]
├── 利用規約 → [F020]
├── プライバシーポリシー → [F030]
├── 退会 → [F040]
└── 戻る → [A040]

[F020: 利用規約]
   └── 戻る → [F010]

[F030: プライバシーポリシー]
   └── 戻る → [F010]

[F040: 退会画面]
   ├── 退会実行 → [A010: PRサイトTOP]
   └── キャンセル → [D010]
```

# LINE Messaging API フロー概要

## システム全体の通知フロー

```
【質問投稿時】
ユーザー（質問者）が LIFF で質問投稿
   ↓
バックエンド：質問データを Firestore に保存
   ↓
マッチングロジック実行（回答者候補を抽出）
   ↓
LINE Messaging API（Push API）
   ↓
回答者の LINE アカウントへ Flex Message で質問通知配信

【回答送信時】
回答者が LINE DM 内で Flex Message のボタンをタップ
   ↓
LINE Messaging API（webhook）でメッセージイベント受信
   ↓
バックエンド：回答データを Firestore に保存
   ↓
LINE Messaging API（Push API）
   ↓
質問者の LINE アカウントへ回答内容を DM で配信

【LIFF での確認】
質問者が LIFF を開く
   ↓
Firestore から回答データを読み込み
   ↓
LIFF 画面（L020）に回答を表示
```

# アーキテクチャのポイント

## Web 画面の役割
* 認証・プロフィール管理
* 質問・回答の一覧表示・検索
* 設定・通知管理
* **質問投稿・回答操作は非対応**

## LIFF の役割
* 質問投稿フォーム（L010-L012）
* 回答確認・管理（L020）
* マイページ（L030）
* **LINE DM での操作はシステムが仲介**

## LINE DM の役割
* 質問・回答の通知配信
* 回答者の回答入力（Flex Message ボタン）
* 質問者への通知受信
* **ユーザー同士の直接連絡を防止**
