# 画面遷移設計書

## 初期導線

```
[A010: PRサイトTOP]
   ├── 会員登録 → [A020: OAuth選択]
   ├── ログイン → [A020: OAuth選択]
   └── 回答してみる → [A041: 質問一覧（公開）]

[A041: 質問一覧（公開）]
   └── 回答ボタン（仮） → [A020: OAuth選択]


[A020: OAuth選択]
   └── LINE認証成功
         ├── 初回 → [A030: 初回プロフィール登録]
         └── 既存 → [A040: ホーム]

[A030: 初回プロフィール登録]
   └── 登録完了 → [A040: ホーム]
```

## ホーム画面（A040）からの遷移

```
[A040: ホーム]
├── タブ切り替え（新着/質問/回答）
│   ├── 新着：更新順に最大10件表示（画面内）
│   ├── 質問：自分の質問一覧（画面内） → [E010: 質問一覧（自分）]
│   └── 回答：自分の回答一覧（画面内）
├── 質問投稿 → [Q010: 質問投稿(Web)]
└── マイページ（アイコン） → [D010: マイページ]
```

## 質問投稿フロー（Web）

### 新規質問・追加質問フロー
```
[Q010: 質問投稿(Web)]
   ├── 質問タイプ選択
   │   ├── 新規質問選択 → [Q010: 質問内容入力]
   │   └── 追加質問選択 → 過去質問選択ステップ → [Q010: 質問内容入力]
   ├── 投稿確認ボタン → [Q011: 質問投稿確認(Web)]
   └── キャンセル → [A040: ホーム]

[Q011: 質問投稿確認(Web)]
   ├── 投稿確定ボタン → [Q012: 質問投稿完了(Web)]
   └── 戻る → [Q010: 質問投稿(Web)]

[Q012: 質問投稿完了(Web)]
   └── ホームボタン → [A040: ホーム]
```

**補足**
* 新規質問：すべてのマッチング対象回答者へ LINE で配信
* 追加質問：新規質問でマッチングした全回答者へ LINE で配信
* 質問は最大3往復（3ラリー制限）で自動クローズされる
* 質問投稿時に AI チェック（NGワード、診断行為、誹謗中傷）を実行し、違反検出時は投稿不可
* 質問投稿後、LINE Bot から回答者へ通知を配信（回答リンク付き）

## 質問閲覧フロー

### 自分の質問（Web）

```
[E010: 質問一覧（自分）]
   ├── 質問選択 → [E030: 質問詳細・回答]
   └── （E030）追加質問ボタン → [Q010: 質問投稿(Web)] （URL に `parentQuestionId` を付与）
```

### 公開質問（Web）

```
[A040: ホーム]
   └── 公開質問選択 → [A041: 質問一覧（公開）]
```

## 回答フロー（Web）

### 回答記入フロー
```
回答者が LINE 通知で受け取ったリンク（?questionId=XXX付き）
   ↓
[Q020: 回答記入(Web)]
   ├── 未認証の場合：OAuth フロー開始 → 認証後 Q020 に戻る
   ├── 回答内容を入力（選択肢、場所、URL、コメント）
   ├── 確認ボタン → [Q021: 回答記入確認(Web)]
   └── キャンセル → [A040: ホーム]

[Q021: 回答記入確認(Web)]
   ├── 送信確定ボタン → [Q022: 回答記入完了(Web)]
   └── 戻る → [Q020: 回答記入(Web)]

[Q022: 回答記入完了(Web)]
   └── プロフィールボタン → [D010: マイページ]
```

**補足：回答フロー（Web ベース）**
* システムが回答者にマッチング後、LINE で質問通知を配信（Q020 へのリンク付き）
* 回答者が LINE 通知のリンクをタップ：
   * 未認証の場合は OAuth フロー開始
   * 認証後、Q020（回答記入）に遷移
* 回答者が以下を入力：
   * 選択肢（必須）
   * 場所情報（任意）
   * URL（任意）
   * 短文コメント（100-140文字、必須）
* 送信前に AI チェック（NGワード、診断行為、誹謗中傷検出）を実行
* 送信後、システムが質問者に LINE で回答通知を配信

## 質問者動線

```
質問者が質問投稿後
   ↓
LINE から回答者へ質問通知配信
   ↓
回答者が Q020 で回答送信
   ↓
LINE から質問者へ回答通知配信
   ↓
質問者が E010 で受け取った回答を確認
```

## マイページ・設定系（Web）

```
[D010: マイページ(Web)]
├── プロフィール編集 → [D020]
├── 設定 → [F010]
└── 戻る → [A040]

[D020: プロフィール編集]
   └── 保存 → [D010]
```

## 履歴閲覧（Web）

ホーム（A040）の「回答」タブ内で一覧・選択を行い、詳細は LIFF で表示します。

## 設定系画面（Web）

```
[D010: マイページ(Web)]
├── プロフィール編集 → [D020]
├── 設定 → [F010]
└── 戻る → [A040]

[F010: 設定]
├── 利用規約 → [F020]
├── プライバシーポリシー → [F030]
├── 退会 → [F040]
└── 戻る → [D010]

[F020: 利用規約]
   └── 戻る → [F010]

[F030: プライバシーポリシー]
   └── 戻る → [F010]

[F040: 退会画面]
   ├── 退会実行 → [A010: PRサイトTOP]
   └── キャンセル → [F010]
## 質問閲覧フロー

### 自分の質問（LIFF）

ホーム（A040）の「質問」タブから質問選択 → [L020: 質問詳細・回答確認(LIFF)]
```

# LINE Messaging API フロー概要

## システム全体の通知フロー

```
【質問投稿時】
ユーザー（質問者）が Q010 で質問投稿
   ↓
Q011 で確認 → Q012 で完了
   ↓
バックエンド：質問データを Firestore に保存
   ↓
マッチングロジック実行（回答者候補を抽出）
   ↓
LINE Messaging API（Push API）
   ↓
回答者の LINE アカウントへ通知配信（Q020 へのリンク付き）

【回答送信時】
回答者が LINE 通知のリンクをタップ
   ↓
Q020（回答記入）へ遷移
   ↓
回答内容を入力 → Q021 で確認 → Q022 で完了
   ↓
バックエンド：回答データを Firestore に保存
   ↓
AI チェック実行（NGワード、診断行為、誹謗中傷検出）
   ↓
LINE Messaging API（Push API）
   ↓
質問者の LINE アカウントへ回答通知配信

【回答確認】
質問者が E010 で回答一覧を確認
```

# アーキテクチャのポイント

## Web 画面の役割
* 認証・プロフィール管理（A020, A030）
* 質問投稿フロー（Q010, Q011, Q012）
* 回答記入フロー（Q020, Q021, Q022）
* 質問・回答の一覧表示・検索（E010, E020）
* 設定・通知管理（D010, D020, F010）

## LINE Messaging API の役割
* 質問・回答の通知配信（Push API）
* 質問通知に Q020 へのリンクを含める
* ユーザー同士の直接連絡を防止
* 通知経由で Web フローへ誘導

## データフロー
* 質問投稿：Q010 → Q011 → Q012 → Firestore → LINE通知
* 回答記入：Q020（LINE通知から遷移） → Q021 → Q022 → Firestore → LINE通知
* 確認：E010/E020 で投稿・回答履歴を Web で閲覧
